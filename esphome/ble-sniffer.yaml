# BLE Intrusion ‚Äì Sniffer, whitelist/blacklist persistantes, alerte eedomus si arm√©
# R√©f√©rence : docs/ble_base.md, docs/config_eedomus_alerte.md
# Secrets : copier esphome/secrets.yaml.example en secrets.yaml (dans esphome/)

substitutions:
  ble_version: "1.4.7"
  name: "ble-intrusion-sniff"
  friendly_name: "BLE Intrusion Sniffer"
  eedomus_host: !secret eedomus_host
  eedomus_api_user: !secret eedomus_api_user
  eedomus_api_secret: !secret eedomus_api_secret
  eedomus_periph_alert: !secret eedomus_periph_alerte

external_components:
  - source:
      type: local
      path: ../components
    components: [ble_persistent_lists]

esphome:
  name: ${name}
  friendly_name: ${friendly_name}
  name_add_mac_suffix: false
  project:
    name: "EtienneESP32.ESP32-BLE-LISTENER"
    version: ${ble_version}
  on_boot:
    - lambda: |-
        id(last_unknown_mac).assign("");
        id(last_seen_mac).assign("");
        id(last_alerted_mac).assign("");
        id(last_alert_time_ms) = 0u;

esp32:
  board: esp32dev
  framework:
    type: arduino

wifi:
  ssid: !secret wifi_ssid
  password: !secret wifi_password
  ap:
    ssid: !secret ap_ssid
    password: !secret ap_password

logger:
  level: INFO
  initial_level: ERROR
  logs:
    ble: INFO
    script: ERROR
    http_request: NONE
    http_request.idf: NONE

api: {}
ota:
  platform: esphome
  password: !secret ota_password
  on_begin:
    - esp32_ble_tracker.stop_scan:

safe_mode:
  id: safe_mode_cmp
  disabled: true

web_server:
  port: 80
  version: 1
  include_internal: false
  css_url: ""
  css_include: esphome_compact.css
  js_include: esphome_compact.js

# http_request:
#   timeout: 15s
#   useragent: "ESPHome-BLE-Sniffer/1.0"

# Listes blanches/rouges persist√©es en NVS (survit au red√©marrage)
ble_persistent_lists:
  id: ble_lists

globals:
  - id: last_unknown_mac
    type: std::string
  - id: last_seen_mac
    type: std::string
  - id: last_alerted_mac
    type: std::string
  - id: last_alert_time_ms
    type: uint32_t
  - id: whitelist_names
    type: std::string
    restore_value: true

# LED bleue (GPIO 2) : flash 500 ms √† chaque sniff
output:
  - platform: gpio
    pin: GPIO2
    id: out_led_blue
switch:
  - platform: output
    name: "LED bleue"
    id: sw_led_blue
    output: out_led_blue
    internal: true
  - platform: template
    name: "Armement alerte BLE"
    id: arm_alert
    optimistic: true
    restore_mode: RESTORE_DEFAULT_OFF

# Scan BLE + logique whitelist / alerte si arm√©
esp32_ble_tracker:
  scan_parameters:
    active: true
    interval: 1129ms
    window: 317ms
  on_ble_advertise:
    - lambda: |-
        std::string mac = x.address_str();
        if (mac.empty()) return;
        id(script_led_flash).execute();
        
        // Si la MAC est en whitelist, on ignore (si cette fonction existe)
        if (id(ble_lists).is_in_whitelist(mac)) return;
        
        std::string device_name = x.get_name();
        
        char c2 = mac.length() >= 2 ? mac[1] : '0';
        std::string mac_type = (c2 == '2' || c2 == '6' || c2 == 'a' || c2 == 'A' || c2 == 'e' || c2 == 'E') ? "[PRIV√âE/AL√âATOIRE]" : "[OFFICIELLE/FIXE]";

        if (!device_name.empty()) {
            // Le Local Name a √©t√© trouv√© gr√¢ce √† l'Active Scan
            ESP_LOGI("ble_sniff", "üìù Nom local d√©tect√©: %s, MAC: %s, RSSI: %d", device_name.c_str(), mac.c_str(), x.get_rssi());
        }

        std::string manuf_str = "";
        for (auto &md : x.get_manufacturer_datas()) {
           if (!manuf_str.empty()) manuf_str += ", ";
           manuf_str += md.uuid.to_string() + ":";
           for (auto b : md.data) {
             char buf[4];
             sprintf(buf, "%02X", b);
             manuf_str += buf;
           }
        }
        
        std::string uuids_str = "";
        for (auto &uuid : x.get_service_uuids()) {
          if (!uuids_str.empty()) uuids_str += ", ";
          uuids_str += uuid.to_string();
        }

        // Anti-doublon simple et affichage
        // On pousse l'adresse MAC d√©tect√©e dans la C++ List, accompagn√©e de son nom s'il existe
        id(ble_lists).add_recent_mac_no_duplicate(mac, device_name, manuf_str, uuids_str);
        
        ESP_LOGI("ble_sniff", "üì° BLE Inconnu d√©tect√© | MAC: %s | Type: %s | Nom: %s", mac.c_str(), mac_type.c_str(), device_name.empty() ? "(Inconnu)" : device_name.c_str());
        
        id(script_lookup_vendor).execute(mac);
        if (!id(arm_alert).state) return;
        uint32_t now = millis();
        uint32_t last = id(last_alert_time_ms);
        if (mac == std::string(id(last_alerted_mac)) && last != 0 && (now - last) < 300000u) return;
        id(last_alerted_mac).assign(mac);
        id(last_alert_time_ms) = now;
        id(script_alert_eedomus).execute(mac);

script:
  - id: script_led_flash
    mode: single
    then:
      - switch.turn_on: sw_led_blue
      - delay: 500ms
      - switch.turn_off: sw_led_blue
  - id: script_alert_eedomus
    mode: queued
    parameters:
      p_mac: std::string
    then:
      - logger.log:
          level: INFO
          format: "Alerte Eedomus DESACTIVEE pour test (MAC inconnue)"

# Script : lookup constructeur (OUI) via API web pour la MAC donn√©e
  - id: script_lookup_vendor
    mode: queued
    parameters:
      p_mac: std::string
    then:
      - text_sensor.template.publish:
          id: text_vendor_web
          state: "Lookup D√©sactiv√© (V1.4.2 Test)"

sensor:
  - platform: wifi_signal
    name: "Signal Wi-Fi"
    update_interval: 60s

text_sensor:
  - platform: template
    name: "Version"
    id: text_version
    lambda: 'return std::string("${ble_version}");'
  - platform: template
    name: "Info constructeur"
    id: text_vendor_web
# --- BEGIN COMPACT UI INCONNUS ---
  - { platform: template, name: "D√©tection 01", id: recent_mac_1, update_interval: 10s, lambda: "std::string m = id(ble_lists).get_recent_mac(0); return m.empty() ? std::string(\"\") : (m.find(\"|\") != std::string::npos ? m : m + \" | (Pas de nom)\");" }
  - { platform: template, name: "D√©tection 02", id: recent_mac_2, update_interval: 10s, lambda: "std::string m = id(ble_lists).get_recent_mac(1); return m.empty() ? std::string(\"\") : (m.find(\"|\") != std::string::npos ? m : m + \" | (Pas de nom)\");" }
  - { platform: template, name: "D√©tection 03", id: recent_mac_3, update_interval: 10s, lambda: "std::string m = id(ble_lists).get_recent_mac(2); return m.empty() ? std::string(\"\") : (m.find(\"|\") != std::string::npos ? m : m + \" | (Pas de nom)\");" }
  - { platform: template, name: "D√©tection 04", id: recent_mac_4, update_interval: 10s, lambda: "std::string m = id(ble_lists).get_recent_mac(3); return m.empty() ? std::string(\"\") : (m.find(\"|\") != std::string::npos ? m : m + \" | (Pas de nom)\");" }
  - { platform: template, name: "D√©tection 05", id: recent_mac_5, update_interval: 10s, lambda: "std::string m = id(ble_lists).get_recent_mac(4); return m.empty() ? std::string(\"\") : (m.find(\"|\") != std::string::npos ? m : m + \" | (Pas de nom)\");" }
  - { platform: template, name: "D√©tection 06", id: recent_mac_6, update_interval: 10s, lambda: "std::string m = id(ble_lists).get_recent_mac(5); return m.empty() ? std::string(\"\") : (m.find(\"|\") != std::string::npos ? m : m + \" | (Pas de nom)\");" }
  - { platform: template, name: "D√©tection 07", id: recent_mac_7, update_interval: 10s, lambda: "std::string m = id(ble_lists).get_recent_mac(6); return m.empty() ? std::string(\"\") : (m.find(\"|\") != std::string::npos ? m : m + \" | (Pas de nom)\");" }
  - { platform: template, name: "D√©tection 08", id: recent_mac_8, update_interval: 10s, lambda: "std::string m = id(ble_lists).get_recent_mac(7); return m.empty() ? std::string(\"\") : (m.find(\"|\") != std::string::npos ? m : m + \" | (Pas de nom)\");" }
  - { platform: template, name: "D√©tection 09", id: recent_mac_9, update_interval: 10s, lambda: "std::string m = id(ble_lists).get_recent_mac(8); return m.empty() ? std::string(\"\") : (m.find(\"|\") != std::string::npos ? m : m + \" | (Pas de nom)\");" }
  - { platform: template, name: "D√©tection 10", id: recent_mac_10, update_interval: 10s, lambda: "std::string m = id(ble_lists).get_recent_mac(9); return m.empty() ? std::string(\"\") : (m.find(\"|\") != std::string::npos ? m : m + \" | (Pas de nom)\");" }
  - { platform: template, name: "D√©tection 11", id: recent_mac_11, update_interval: 10s, lambda: "std::string m = id(ble_lists).get_recent_mac(10); return m.empty() ? std::string(\"\") : (m.find(\"|\") != std::string::npos ? m : m + \" | (Pas de nom)\");" }
  - { platform: template, name: "D√©tection 12", id: recent_mac_12, update_interval: 10s, lambda: "std::string m = id(ble_lists).get_recent_mac(11); return m.empty() ? std::string(\"\") : (m.find(\"|\") != std::string::npos ? m : m + \" | (Pas de nom)\");" }
  - { platform: template, name: "D√©tection 13", id: recent_mac_13, update_interval: 10s, lambda: "std::string m = id(ble_lists).get_recent_mac(12); return m.empty() ? std::string(\"\") : (m.find(\"|\") != std::string::npos ? m : m + \" | (Pas de nom)\");" }
  - { platform: template, name: "D√©tection 14", id: recent_mac_14, update_interval: 10s, lambda: "std::string m = id(ble_lists).get_recent_mac(13); return m.empty() ? std::string(\"\") : (m.find(\"|\") != std::string::npos ? m : m + \" | (Pas de nom)\");" }
  - { platform: template, name: "D√©tection 15", id: recent_mac_15, update_interval: 10s, lambda: "std::string m = id(ble_lists).get_recent_mac(14); return m.empty() ? std::string(\"\") : (m.find(\"|\") != std::string::npos ? m : m + \" | (Pas de nom)\");" }
  - { platform: template, name: "D√©tection 16", id: recent_mac_16, update_interval: 10s, lambda: "std::string m = id(ble_lists).get_recent_mac(15); return m.empty() ? std::string(\"\") : (m.find(\"|\") != std::string::npos ? m : m + \" | (Pas de nom)\");" }
  - { platform: template, name: "D√©tection 17", id: recent_mac_17, update_interval: 10s, lambda: "std::string m = id(ble_lists).get_recent_mac(16); return m.empty() ? std::string(\"\") : (m.find(\"|\") != std::string::npos ? m : m + \" | (Pas de nom)\");" }
  - { platform: template, name: "D√©tection 18", id: recent_mac_18, update_interval: 10s, lambda: "std::string m = id(ble_lists).get_recent_mac(17); return m.empty() ? std::string(\"\") : (m.find(\"|\") != std::string::npos ? m : m + \" | (Pas de nom)\");" }
  - { platform: template, name: "D√©tection 19", id: recent_mac_19, update_interval: 10s, lambda: "std::string m = id(ble_lists).get_recent_mac(18); return m.empty() ? std::string(\"\") : (m.find(\"|\") != std::string::npos ? m : m + \" | (Pas de nom)\");" }
  - { platform: template, name: "D√©tection 20", id: recent_mac_20, update_interval: 10s, lambda: "std::string m = id(ble_lists).get_recent_mac(19); return m.empty() ? std::string(\"\") : (m.find(\"|\") != std::string::npos ? m : m + \" | (Pas de nom)\");" }
# --- END COMPACT UI INCONNUS ---

# UI nettoyee - Les boutons whitelist et lookup sont desormais geres autrement ou supprimes


